<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thank You for Logging!</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Leaflet CSS for the map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    .state-shade {
      fill: darkred;
      fill-opacity: 0.4;
      stroke: #660000;
      stroke-width: 1;
    }

    .gold-pin {
      background-color: gold;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: block;
      border: 2px solid #aa8800;
    }

    .leaflet-popup-content-wrapper {
      background: #fff8e1;
      color: #333;
    }

    select {
      width: 100%;
      padding: 10px;
      margin: 20px 0;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #8B0000;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <img src="tribal dragon for coin 2.svg" alt="Treasure Coin Logo" width="50" />
    <h1>Thank You for Logging a Treasure Coin!</h1>
    <p>Your data has been submitted. Below is a map showing where Treasure Coins have been found.<br> If you don't see your location, please refresh the page.</p>
  </header>

  <div id="map"></div>

  <div>
    <h2>Select a Treasure Coin to View Logs</h2>
    <select id="coin-select">
      <option value="all" selected>All Coins</option>
      <option value="TC001">TC001</option>
      <option value="TC002">TC002</option>
      <option value="TC003">TC003</option>
      <option value="TC004">TC004</option>
      <option value="TC005">TC005</option>
      <option value="TC006">TC006</option>
      <option value="TC007">TC007</option>
      <option value="TC008">TC008</option>
      <option value="TC009">TC009</option>
      <option value="TC010">TC010</option>
    </select>
  </div>

  <div>
    <h2>Log Data</h2>
    <table id="log-table">
      <thead>
        <tr>
          <th>Coin ID</th>
          <th>Cache ID</th>
          <th>City</th>
          <th>State</th>
          <th>Date Found</th>
          <th>Username</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <!-- Log data will be injected here -->
      </tbody>
    </table>
  </div>

  <footer>
    <p>Please hide the coin and let the journey continue! Thank you for keeping the adventure alive!</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- TopoJSON for US state boundaries -->
  <script src="https://unpkg.com/us-atlas@3/states-10m.json"></script>
  <!-- D3 for topojson conversion -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>

  <script>
    const map = L.map('map').setView([39.5, -98.35], 4); // Center of U.S.

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // Load public Google Sheet data as CSV
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTWaKxHd44JeIfYteVBQJIZ4iMG6GoVARO6tqRpoorC5FrSiAhDktAxm7GpLwJ2ZozdIANpE0p2F9HM/pub?output=csv')
      .then(response => response.text())
      .then(csvText => {
        const rows = csvText.split('\n').slice(1); // Skip header
        const cities = [];
        const states = new Set();

        rows.forEach(row => {
          const cols = row.split(',');
          const city = cols[3]?.trim();
          const state = cols[4]?.trim();
          if (city && state) {
            cities.push({ city, state });
            states.add(state);
          }
        });

        // Plot pins for each city
        cities.forEach(entry => {
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(entry.city + ', ' + entry.state)}`)
            .then(res => res.json())
            .then(data => {
              if (data.length > 0) {
                const loc = data[0];
                const marker = L.circleMarker([loc.lat, loc.lon], {
                  radius: 7,
                  color: '#aa8800',
                  fillColor: 'gold',
                  fillOpacity: 0.9
                }).addTo(map);
                marker.bindPopup(`<strong>${entry.city}, ${entry.state}</strong>`);
              }
            });
        });

        // Shade states
        fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
          .then(res => res.json())
          .then(us => {
            const geojson = topojson.feature(us, us.objects.states);
            geojson.features.forEach(f => {
              const stateName = f.properties.name;
              if (Array.from(states).includes(stateName)) {
                L.geoJSON(f, {
                  style: {
                    fillColor: "darkred",
                    color: "#660000",
                    weight: 1,
                    fillOpacity: 0.4
                  }
                }).addTo(map);
              }
            });
          });
      });

    // Handle coin selection
    document.getElementById('coin-select').addEventListener('change', function() {
      const coinId = this.value;
      fetchCoinLogs(coinId);
    });

    // Fetch coin logs
    function fetchCoinLogs(coinId) {
      const url = coinId === 'all' 
        ? 'https://script.google.com/macros/s/AKfycbzEIUQih0nlQT4nNJ_L5t4TmZihrW7ChGMIFTBxVrRry870X1a8cZ-qnbnGcG89fw6D/exec' 
        : `https://script.google.com/macros/s/AKfycbzEIUQih0nlQT4nNJ_L5t4TmZihrW7ChGMIFTBxVrRry870X1a8cZ-qnbnGcG89fw6D/exec?coin_id=${coinId}`;

      fetch(url)
        .then(response => response.json())
        .then(logs => {
          displayLogs(logs);
        })
        .catch(error => console.error('Error fetching coin logs:', error));
    }

    // Display the logs in a table
    function displayLogs(logs) {
      const tbody = document.getElementById('log-table').querySelector('tbody');
      tbody.innerHTML = ''; // Clear previous logs

      if (logs.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="7">No logs available for the selected coin.</td>';
        tbody.appendChild(row);
        return;
      }

      logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${log.coin_id}</td>
          <td>${log.cache_id}</td>
          <td>${log.city}</td>
          <td>${log.state}</td>
          <td>${log.date_found}</td>
          <td>${log.username}</td>
          <td>${log.description}</td>
        `;
        tbody.appendChild(row);
      });
    }
    // Load all coin logs on page load
    fetchCoinLogs('all');
  </script>

</body>
</html>
