<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thank You for Logging!</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { background-color: #DAA520; font-family: sans-serif; color: black; }
    h1, h2 { color: darkred; }
    a, button, select { color: darkred; background-color: black; }

    #map { height: 400px; margin-bottom: 20px; }

    .state-shade {
      fill: darkred;
      fill-opacity: 0.4;
      stroke: #660000;
      stroke-width: 1;
    }

    select {
      width: 100%;
      padding: 10px;
      margin: 20px 0;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #8B0000;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <img src="tribal dragon for coin 2.svg" alt="Treasure Coin Logo" width="50" />
    <h1>Thank You for Logging a Treasure Coin!</h1>
    <p>Your data has been submitted. Below is a map showing where Treasure Coins have been found.<br> If you don't see your location, please refresh the page.</p>
  </header>

  <div id="map"></div>

  <div>
    <h2>Select a Treasure Coin to View Logs</h2>
    <select id="coin-select">
      <option value="all" selected>All Coins</option>
    </select>
  </div>

  <div>
    <h2>Log Data</h2>
    <table id="log-table">
      <thead>
        <tr>
          <th>Coin ID</th>
          <th>Cache ID</th>
          <th>City</th>
          <th>State</th>
          <th>Date Found</th>
          <th>Username</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>
    <p>Please hide the coin and let the journey continue! Thank you for keeping the adventure alive!</p>
  </footer>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>

  <script>
    const stateIdToName = {
      "01": "Alabama", "02": "Alaska", "04": "Arizona", "05": "Arkansas",
      "06": "California", "08": "Colorado", "09": "Connecticut", "10": "Delaware",
      "11": "District of Columbia", "12": "Florida", "13": "Georgia", "15": "Hawaii",
      "16": "Idaho", "17": "Illinois", "18": "Indiana", "19": "Iowa",
      "20": "Kansas", "21": "Kentucky", "22": "Louisiana", "23": "Maine",
      "24": "Maryland", "25": "Massachusetts", "26": "Michigan", "27": "Minnesota",
      "28": "Mississippi", "29": "Missouri", "30": "Montana", "31": "Nebraska",
      "32": "Nevada", "33": "New Hampshire", "34": "New Jersey", "35": "New Mexico",
      "36": "New York", "37": "North Carolina", "38": "North Dakota", "39": "Ohio",
      "40": "Oklahoma", "41": "Oregon", "42": "Pennsylvania", "44": "Rhode Island",
      "45": "South Carolina", "46": "South Dakota", "47": "Tennessee", "48": "Texas",
      "49": "Utah", "50": "Vermont", "51": "Virginia", "53": "Washington",
      "54": "West Virginia", "55": "Wisconsin", "56": "Wyoming"
    };

    const map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    // Dynamic dropdown + state/city processing
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTWaKxHd44JeIfYteVBQJIZ4iMG6GoVARO6tqRpoorC5FrSiAhDktAxm7GpLwJ2ZozdIANpE0p2F9HM/pub?output=csv')
      .then(res => res.text())
      .then(csv => {
        const rows = csv.trim().split('\n').slice(1).map(row => row.split(','));
        const states = new Set();
        const cities = [];
        const coins = new Set();

        rows.forEach(([coin_id, , city, state]) => {
          if (coin_id) coins.add(coin_id.trim());
          if (city && state) {
            cities.push({ city: city.trim(), state: state.trim() });
            states.add(state.trim());
          }
        });

        // Update dropdown
        const select = document.getElementById('coin-select');
        coins.forEach(coin => {
          const option = document.createElement('option');
          option.value = coin;
          option.textContent = coin;
          select.appendChild(option);
        });

        // Plot city markers
        cities.forEach(({ city, state }) => {
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + ', ' + state)}`)
            .then(r => r.json())
            .then(data => {
              if (data.length > 0) {
                const loc = data[0];
                L.circleMarker([loc.lat, loc.lon], {
                  radius: 7,
                  color: '#aa8800',
                  fillColor: 'gold',
                  fillOpacity: 0.9
                }).addTo(map).bindPopup(`<strong>${city}, ${state}</strong>`);
              }
            });
        });

        // Shade visited states
        fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
          .then(r => r.json())
          .then(us => {
            const geojson = topojson.feature(us, us.objects.states);
            geojson.features.forEach(f => {
              const id = f.id.toString().padStart(2, '0');
              const name = stateIdToName[id];
              if (states.has(name)) {
                L.geoJSON(f, {
                  style: {
                    fillColor: "darkred",
                    color: "#660000",
                    weight: 1,
                    fillOpacity: 0.4
                  }
                }).addTo(map);
              }
            });
          });
      });

    // Load logs
    function fetchCoinLogs(coinId) {
      const url = coinId === 'all'
        ? 'https://script.google.com/macros/s/AKfycbzEIUQih0nlQT4nNJ_L5t4TmZihrW7ChGMIFTBxVrRry870X1a8cZ-qnbnGcG89fw6D/exec'
        : `https://script.google.com/macros/s/AKfycbzEIUQih0nlQT4nNJ_L5t4TmZihrW7ChGMIFTBxVrRry870X1a8cZ-qnbnGcG89fw6D/exec?coin_id=${coinId}`;

      fetch(url)
        .then(res => res.json())
        .then(data => displayLogs(data))
        .catch(err => console.error('Fetch error:', err));
    }

    function displayLogs(logs) {
      const tbody = document.querySelector('#log-table tbody');
      tbody.innerHTML = '';
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No logs available for the selected coin.</td></tr>';
        return;
      }

      logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${log.coin_id}</td>
          <td>${log.cache_id}</td>
          <td>${log.city}</td>
          <td>${log.state}</td>
          <td>${log.date_found}</td>
          <td>${log.username}</td>
          <td>${log.description}</td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById('coin-select').addEventListener('change', function () {
      fetchCoinLogs(this.value);
    });

    fetchCoinLogs('all');
  </script>
</body>
</html>
