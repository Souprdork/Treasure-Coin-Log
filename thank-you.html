<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thank You for Logging!</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Leaflet CSS for the map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    .state-shade {
      fill: darkred;
      fill-opacity: 0.4;
      stroke: #660000;
      stroke-width: 1;
    }

    .gold-pin {
      background-color: gold;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: block;
      border: 2px solid #aa8800;
    }

    .leaflet-popup-content-wrapper {
      background: #fff8e1;
      color: #333;
    }
  </style>
</head>
<body>
 <div style="text-align: center; margin: 20px 0;">
    <img src="tribal dragon for coin 2.svg" alt="Treasure Coin Logo" width="150" />
  </div>
  
  <header>

    <h1>Thank You for Logging a Treasure Coin!</h1>
    <p>Your log has been submitted. Below is a map showing where Treasure Coins have been found.</p>
  </header>

  <div id="map"></div>

  <footer>
    <p>Thank you for keeping the adventure alive. Hide the coin and let the journey continue!</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- TopoJSON for US state boundaries -->
  <script src="https://unpkg.com/us-atlas@3/states-10m.json"></script>
  <!-- D3 for topojson conversion -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>

  <script>
    const map = L.map('map').setView([39.5, -98.35], 4); // Center of U.S.

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // Load public Google Sheet data as CSV
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTWaKxHd44JeIfYteVBQJIZ4iMG6GoVARO6tqRpoorC5FrSiAhDktAxm7GpLwJ2ZozdIANpE0p2F9HM/pub?output=csv')
      .then(response => response.text())
      .then(csvText => {
        const rows = csvText.split('\n').slice(1); // Skip header
        const cities = [];
        const states = new Set();

        rows.forEach(row => {
          const cols = row.split(',');
          const city = cols[3]?.trim();
          const state = cols[4]?.trim();
          if (city && state) {
            cities.push({ city, state });
            states.add(state);
          }
        });

        // Plot pins for each city
        cities.forEach(entry => {
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(entry.city + ', ' + entry.state)}`)
            .then(res => res.json())
            .then(data => {
              if (data.length > 0) {
                const loc = data[0];
                const marker = L.circleMarker([loc.lat, loc.lon], {
                  radius: 7,
                  color: '#aa8800',
                  fillColor: 'gold',
                  fillOpacity: 0.9
                }).addTo(map);
                marker.bindPopup(`<strong>${entry.city}, ${entry.state}</strong>`);
              }
            });
        });

        // Shade states
        fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
          .then(res => res.json())
          .then(us => {
            const geojson = topojson.feature(us, us.objects.states);
            geojson.features.forEach(f => {
              const stateName = f.properties.name;
              if (Array.from(states).includes(stateName)) {
                L.geoJSON(f, {
                  style: {
                    fillColor: "darkred",
                    color: "#660000",
                    weight: 1,
                    fillOpacity: 0.4
                  }
                }).addTo(map);
              }
            });
          });
      });
  </script>
</body>
</html>
